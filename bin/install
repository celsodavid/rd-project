#!/bin/bash

export UID=${UID}
export GID=${GID}

echo -e "\nConfigurando permissão de diretórios\n";
sudo chmod 777 -R .docker/percona_data;
sudo chmod 777 -R .docker/es_data;
sudo chmod 777 -R .docker/mongo_data;

echo -e "\nParando serviços docker\n";
docker-compose stop;
echo -e "\nBuild do docker\n";
docker-compose build;
echo -e "\nIniciando serviços docker\n";
docker-compose up -d; docker-compose ps;

echo -e "\n"
bin/ssl

echo -e "\nInicializando submódulos\n";
git submodule init; git submodule update;
echo -e "\nInstalação dos módulos Composer\n";
docker-compose exec php bash -c "chmod 777 -R /usr/local/.composer && composer install";
echo -e "\nPermissão de diretórios Magento 2\n";
docker-compose exec php bash -c "find var generated vendor pub/static pub/media app/etc -type f -exec chmod g+w {} +";
docker-compose exec php bash -c "find var generated vendor pub/static pub/media app/etc -type d -exec chmod g+ws {} +";
docker-compose exec php bash -c "chmod u+x bin/magento";

echo -e "\nRestore do banco de dados\n";
bin/mysql restore

bin/setup